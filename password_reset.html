<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Reset your password</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/png" href="assets/favicon.png">
    <!-- Supabase JS v2 (browser bundle) -->
    <script src="https://esm.sh/@supabase/supabase-js@2.45.4"></script>
    <style>
      :root{
        --bg: #ffffff;
        --fg: #0b0b0c;
        --muted: #6b7280;
        --ok: #0a7d29;
        --err: #c02e2e;
        --ring: #2563eb;
        --card: #f8fafc;
        --border: #e5e7eb;
        --shadow: 0 8px 30px rgba(0,0,0,.08);
      }
      @media (prefers-color-scheme: dark){
        :root{
          --bg: #0b0b0c;
          --fg: #eef2f7;
          --muted: #a3a9b5;
          --ok: #34d399;
          --err: #f87171;
          --ring: #60a5fa;
          --card: #111217;
          --border: #1f2430;
          --shadow: 0 8px 30px rgba(0,0,0,.35);
        }
      }

      /* Page layout */
      html, body { height: 100%; }
      body{
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .wrap{
        min-height: 100dvh;
        display: grid;
        place-items: center;
        padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right))
                 max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
      }

      .card{
        width: 100%;
        max-width: 420px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 20px;
      }

      header{
        margin-bottom: 14px;
      }
      h1{
        font-size: clamp(1.25rem, 2.5vw + .9rem, 1.5rem);
        line-height: 1.2;
        margin: 0 0 6px;
      }
      .sub{
        margin: 0;
        color: var(--muted);
        font-size: .95rem;
      }

      /* Status messages */
      #status{
        margin: 12px 0 14px;
        padding: 10px 12px;
        border-radius: 12px;
        background: transparent;
        border: 1px dashed transparent;
        font-size: .95rem;
      }
      #status.ok{ color: var(--ok); background: color-mix(in oklab, var(--ok) 12%, transparent); border-color: color-mix(in oklab, var(--ok) 35%, transparent); }
      #status.err{ color: var(--err); background: color-mix(in oklab, var(--err) 12%, transparent); border-color: color-mix(in oklab, var(--err) 35%, transparent); }
      #status.neutral{ color: var(--muted); background: color-mix(in oklab, var(--fg) 6%, transparent); border-color: var(--border); }

      /* Form */
      form{
        display: grid;
        gap: 12px;
        margin-top: 4px;
      }

      .field{
        display: grid;
        gap: 6px;
      }
      label{
        font-size: .95rem;
      }

      .control{
        position: relative;
      }
      input[type="password"]{
        width: 100%;
        height: 52px; /* 48px+ for thumb comfort */
        padding: 0 44px 0 14px;
        font-size: 16px; /* prevents iOS zoom */
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 12px;
        outline: none;
        transition: border-color .15s ease, box-shadow .15s ease;
      }
      input::placeholder{ color: color-mix(in oklab, var(--muted) 70%, transparent); }
      input:focus{
        border-color: var(--ring);
        box-shadow: 0 0 0 4px color-mix(in oklab, var(--ring) 18%, transparent);
      }

      .toggle{
        position: absolute;
        right: 6px;
        top: 50%;
        translate: 0 -50%;
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 8px 10px;
        border-radius: 10px;
        font-size: .95rem;
      }
      .toggle:focus-visible{
        outline: 2px solid var(--ring);
        outline-offset: 2px;
      }

      button[type="submit"]{
        height: 52px;
        font-size: 16px;
        font-weight: 600;
        border: 0;
        color: #fff;
        background: linear-gradient(180deg, #2563eb, #1d4ed8);
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(37,99,235,.35);
        cursor: pointer;
        transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      }
      button[type="submit"]:hover{ filter: brightness(1.03); }
      button[type="submit"]:active{ transform: translateY(1px); box-shadow: 0 4px 12px rgba(37,99,235,.25); }
      button[disabled]{ opacity: .65; cursor: not-allowed; box-shadow: none; }

      .hint{
        text-align: center;
        color: var(--muted);
        font-size: .9rem;
        margin-top: 4px;
      }

      /* Reduce motion niceties */
      @media (prefers-reduced-motion: no-preference){
        .card{ animation: pop .18s ease-out; }
        @keyframes pop{ from{ transform: translateY(6px); opacity: .001 } to{ transform: none; opacity: 1 } }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <main class="card" role="main">
        <header>
          <h1>Set a new password</h1>
          <p class="sub">For your security, choose something unique.</p>
        </header>

        <p id="status" class="neutral" role="status" aria-live="polite">Checking your reset link…</p>

        <form id="form" style="display:none" novalidate>
          <div class="field">
            <label for="pw1">New password</label>
            <div class="control">
              <input id="pw1" type="password" placeholder="Enter a strong password" required
                     autocomplete="new-password" inputmode="text" />
              <button class="toggle" type="button" aria-label="Show password" data-target="pw1">Show</button>
            </div>
          </div>

          <div class="field">
            <label for="pw2">Confirm password</label>
            <div class="control">
              <input id="pw2" type="password" placeholder="Re-enter password" required
                     autocomplete="new-password" inputmode="text" />
              <button class="toggle" type="button" aria-label="Show password" data-target="pw2">Show</button>
            </div>
          </div>

          <button id="submitBtn" type="submit">Update password</button>
          <p class="hint">You’ll stay signed in after updating.</p>
        </form>
      </main>
    </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

  const SUPABASE_URL = "https://gubxeiodxwqzrywwyckk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1YnhlaW9keHdxenJ5d3d5Y2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY0NTkwMzEsImV4cCI6MjA1MjAzNTAzMX0.5VdplmwuESY7f5c9kl_I1lwvqDpBfZV5pITKjkNg0Fc";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const statusEl = document.getElementById("status");
  const formEl = document.getElementById("form");
  const submitBtn = document.getElementById("submitBtn");

  function setStatus(kind, msg) {
    statusEl.className = kind || "neutral"; // "neutral", "ok", "err"
    statusEl.textContent = msg;
  }

  // Show/Hide password toggles (mobile-friendly)
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".toggle");
    if (!btn) return;
    const id = btn.getAttribute("data-target");
    const input = document.getElementById(id);
    const isHidden = input.type === "password";
    input.type = isHidden ? "text" : "password";
    btn.textContent = isHidden ? "Hide" : "Show";
    btn.setAttribute("aria-label", isHidden ? "Hide password" : "Show password");
    input.focus({ preventScroll: true });
  });

  function setLoading(loading) {
    submitBtn.disabled = loading;
    if (loading) {
      submitBtn.dataset.original = submitBtn.textContent;
      submitBtn.textContent = "Updating…";
    } else {
      submitBtn.textContent = submitBtn.dataset.original || "Update password";
    }
  }

  async function establishRecoverySession() {
    try {
      const qs = new URLSearchParams(window.location.search);
      const tokenHash = qs.get("token_hash");
      const type = qs.get("type");

      if (!tokenHash) throw new Error("No token_hash found in the URL.");
      if (type && type !== "recovery") {
        throw new Error(`Unexpected type "${type}". Expected "recovery".`);
      }

      // Clean up address bar (remove any extras like &email=...)
      const cleanQS = new URLSearchParams();
      cleanQS.set("token_hash", tokenHash);
      if (type) cleanQS.set("type", type);
      const cleanURL = `${location.pathname}?${cleanQS.toString()}`;
      window.history.replaceState({}, "", cleanURL);

      const { error } = await supabase.auth.verifyOtp({
        type: "recovery",
        token_hash: tokenHash
      });
      if (error) throw error;

      return true;
    } catch (e) {
      setStatus("err", `Reset link error: ${e.message}`);
      return false;
    }
  }

  async function main() {
    const ok = await establishRecoverySession();
    if (!ok) return;

    setStatus("ok", "Reset link verified. Enter a new password.");
    formEl.style.display = "grid";

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const pw1 = document.getElementById("pw1").value.trim();
      const pw2 = document.getElementById("pw2").value.trim();

      if (!pw1 || pw1 !== pw2) {
        setStatus("err", "Passwords must match.");
        return;
      }
      if (pw1.length < 8) {
        setStatus("err", "Use at least 8 characters.");
        return;
      }

      setStatus("neutral", "Updating…");
      setLoading(true);
      const { error } = await supabase.auth.updateUser({ password: pw1 });
      setLoading(false);

      if (error) {
        setStatus("err", `Update failed: ${error.message}`);
      } else {
        formEl.style.display = "none";
        setStatus("ok", "Password updated. You can now sign in.");
      }
    });
  }

  main();
</script>
  </body>
</html>
